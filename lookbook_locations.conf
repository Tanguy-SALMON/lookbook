# Lookbook-MPC Nginx Location Configuration
# This file contains the location blocks for Lookbook-MPC services
# It can be included in both HTTP and HTTPS server blocks

# Magento location block (assuming Magento is at /magento)
location /magento {
    proxy_pass http://magento_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Magento-specific timeouts
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
    proxy_send_timeout 60s;

    # Buffer settings
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
}

# Lookbook-MPC API endpoints
location /lookbook/ {
    # Rate limiting for API
    limit_req zone=api_limit burst=10 nodelay;

    # Request ID propagation
    proxy_set_header X-Request-ID $http_x_request_id;
    proxy_set_header X-Request-Id $http_x_request_id;

    # Proxy settings
    proxy_pass http://lookbook_api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeouts
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
    proxy_send_timeout 5s;

    # Health check
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # CORS headers
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# Lookbook-MPC Vision endpoints
location /lookbook/vision/ {
    # Rate limiting for vision (more restrictive)
    limit_req zone=vision_limit burst=5 nodelay;

    # Request ID propagation
    proxy_set_header X-Request-ID $http_x_request_id;
    proxy_set_header X-Request-Id $http_x_request_id;

    # Proxy settings
    proxy_pass http://lookbook_vision;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Longer timeout for vision processing
    proxy_connect_timeout 5s;
    proxy_read_timeout 120s;
    proxy_send_timeout 5s;

    # Health check
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings for large image responses
    proxy_buffering on;
    proxy_buffer_size 8k;
    proxy_buffers 16 8k;
    proxy_busy_buffers_size 16k;

    # CORS headers
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# MCP endpoints
location /lookbook/mcp/ {
    # Rate limiting for MCP
    limit_req zone=mcp_limit burst=20 nodelay;

    # Request ID propagation
    proxy_set_header X-Request-ID $http_x_request_id;
    proxy_set_header X-Request-Id $http_x_request_id;

    # Proxy settings
    proxy_pass http://lookbook_api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeouts
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
    proxy_send_timeout 5s;

    # Health check
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # CORS headers
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept, Authorization";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# Demo UI
location /lookbook/demo {
    proxy_pass http://lookbook_api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache static demo content
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
}

# API documentation
location /lookbook/docs {
    proxy_pass http://lookbook_api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Cache documentation
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
}

# Health checks
location /lookbook/health {
    proxy_pass http://lookbook_api;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # No caching for health checks
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# Root redirect
location / {
    return 301 /magento/;
}