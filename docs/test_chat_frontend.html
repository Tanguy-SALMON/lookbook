<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Frontend Test - Lookbook MPC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .typing-indicator {
        display: inline-block;
        animation: pulse 1.5s ease-in-out infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 0.4;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.4;
        }
      }
      .status-connected {
        color: #10b981;
      }
      .status-disconnected {
        color: #ef4444;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
          Chat Frontend Test
        </h1>
        <p class="text-gray-600">Testing chat with product recommendations</p>
        <div id="connectionStatus" class="mt-2 text-sm">
          <span id="statusText" class="status-disconnected"
            >Checking connection...</span
          >
        </div>
      </div>

      <!-- Quick Test Buttons -->
      <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">
          Quick Tests (Known Working Queries)
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button
            onclick="testQuery('I want to go dancing tonight')"
            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
          >
            Test: Dancing Tonight
          </button>
          <button
            onclick="testQuery('I need party outfits')"
            class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 transition-colors"
          >
            Test: Party Outfits
          </button>
          <button
            onclick="testQuery('Show me something stylish')"
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors"
          >
            Test: Something Stylish
          </button>
          <button
            onclick="testQuery('I want elegant clothes')"
            class="px-4 py-2 bg-pink-500 text-white rounded hover:bg-pink-600 transition-colors"
          >
            Test: Elegant Clothes
          </button>
        </div>
      </div>

      <!-- Chat Interface -->
      <div class="bg-white rounded-lg shadow-sm">
        <!-- Chat Messages -->
        <div
          id="chatMessages"
          class="h-96 overflow-y-auto p-6 border-b border-gray-200"
        >
          <div class="text-center text-gray-500 text-sm">
            Chat will appear here...
          </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4">
          <div class="flex gap-3">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message here..."
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              onkeypress="handleKeyPress(event)"
            />
            <button
              id="sendButton"
              onclick="sendMessage()"
              class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-300"
            >
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- Product Recommendations -->
      <div id="recommendationsSection" class="mt-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Product Recommendations</h2>
        <div
          id="productGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- Products will be inserted here -->
        </div>
      </div>

      <!-- Debug Info -->
      <div class="mt-8 bg-gray-100 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-2">Debug Info</h3>
        <div id="debugInfo" class="text-xs text-gray-600 font-mono">
          Ready for testing...
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8000";
      let sessionId = "test_session_" + Date.now();

      // Check connection status
      async function checkConnection() {
        try {
          const response = await fetch(`${API_BASE}/health`);
          if (response.ok) {
            document.getElementById("statusText").textContent =
              "Connected to backend";
            document.getElementById("statusText").className =
              "status-connected";
            return true;
          }
        } catch (error) {
          document.getElementById("statusText").textContent =
            "Backend not available";
          document.getElementById("statusText").className =
            "status-disconnected";
          return false;
        }
        return false;
      }

      // Add message to chat
      function addMessage(message, isUser = false, hasRecommendations = false) {
        const chatMessages = document.getElementById("chatMessages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `mb-4 ${isUser ? "text-right" : "text-left"}`;

        const bubble = document.createElement("div");
        bubble.className = `inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
          isUser ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-800"
        }`;

        bubble.textContent = message;
        messageDiv.appendChild(bubble);
        chatMessages.appendChild(messageDiv);

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Show typing indicator
      function showTypingIndicator() {
        const chatMessages = document.getElementById("chatMessages");
        const typingDiv = document.createElement("div");
        typingDiv.id = "typingIndicator";
        typingDiv.className = "mb-4 text-left";

        const bubble = document.createElement("div");
        bubble.className =
          "inline-block px-4 py-2 bg-gray-200 text-gray-500 rounded-lg typing-indicator";
        bubble.textContent = "Assistant is typing...";

        typingDiv.appendChild(bubble);
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Hide typing indicator
      function hideTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Display product recommendations
      function displayRecommendations(outfits) {
        const recommendationsSection = document.getElementById(
          "recommendationsSection"
        );
        const productGrid = document.getElementById("productGrid");

        if (!outfits || outfits.length === 0) {
          recommendationsSection.classList.add("hidden");
          return;
        }

        productGrid.innerHTML = "";
        recommendationsSection.classList.remove("hidden");

        outfits.forEach((outfit) => {
          const outfitCard = document.createElement("div");
          outfitCard.className =
            "bg-white border border-gray-200 rounded-lg p-4 shadow-sm";

          const itemsHtml = outfit.items
            .map((item) => {
              const images = getImageVariations(item.image_url);
              const productUrl = getProductUrl(item);
              return `
                    <div class="border border-gray-200 rounded-lg overflow-hidden bg-white transition-transform duration-200 hover:-translate-y-0.5 mb-3">
                        <a href="${productUrl}" target="_blank" class="no-underline text-inherit block">
                            <img src="${images.main}"
                                 alt="${item.title}"
                                 class="w-full h-32 object-cover object-top rounded-md"
                                 onerror="this.src='https://via.placeholder.com/200x200?text=No+Image'">
                            <div class="p-2">
                                <div class="font-medium text-sm text-gray-900">${item.title}</div>
                                <div class="text-sm text-blue-600 font-semibold">฿${item.price}</div>
                                <div class="text-xs text-gray-500">${item.color} • ${item.category}</div>
                            </div>
                        </a>
                    </div>
                    `;
            })
            .join("");

          outfitCard.innerHTML = `
                    <h3 class="font-semibold text-gray-900 mb-3">${
                      outfit.title
                    }</h3>
                    ${itemsHtml}
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Total: ฿${
                              outfit.total_price
                            }</span>
                            <span class="text-xs text-green-600">${Math.round(
                              outfit.score * 100
                            )}% Match</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">${
                          outfit.rationale
                        }</div>
                    </div>
                `;

          productGrid.appendChild(outfitCard);
        });
      }

      // Send message to API
      async function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (!message) return;

        const sendButton = document.getElementById("sendButton");
        sendButton.disabled = true;

        // Add user message
        addMessage(message, true);
        input.value = "";

        // Show typing indicator
        showTypingIndicator();

        try {
          const response = await fetch(`${API_BASE}/v1/chat`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              session_id: sessionId,
              message: message,
            }),
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          hideTypingIndicator();

          // Add assistant response
          if (data.replies && data.replies.length > 0) {
            addMessage(data.replies[0].message);
          }

          // Display recommendations if any
          displayRecommendations(data.outfits);

          // Update debug info
          updateDebugInfo({
            status: "success",
            outfits_count: data.outfits ? data.outfits.length : 0,
            request_id: data.request_id,
            session_id: data.session_id,
          });
        } catch (error) {
          hideTypingIndicator();
          addMessage(`Error: ${error.message}`);
          updateDebugInfo({
            status: "error",
            error: error.message,
          });
        }

        sendButton.disabled = false;
      }

      // Test query function
      function testQuery(query) {
        document.getElementById("messageInput").value = query;
        sendMessage();
      }

      // Handle Enter key press
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        }
      }

      // Utility function to generate different image views
      function getImageVariations(baseImageUrl) {
        if (!baseImageUrl) {
          return {
            main: "https://via.placeholder.com/200x200?text=No+Image",
            view2: "https://via.placeholder.com/200x200?text=View+2",
            view3: "https://via.placeholder.com/200x200?text=Detail",
          };
        }

        return {
          main: baseImageUrl,
          view2: baseImageUrl.replace(/_xxl-1\.(jpg|png)$/, "_xxl-2.$1"),
          view3: baseImageUrl.replace(/_xxl-1\.(jpg|png)$/, "_xxl-3.$1"),
        };
      }

      // Utility function to generate product URL
      function getProductUrl(item) {
        if (item.product_url) {
          return item.product_url;
        }
        if (item.sku) {
          return `https://th.cos.com/th_en/${item.sku}.html`;
        }
        return "#";
      }

      // Update debug info
      function updateDebugInfo(info) {
        const debugElement = document.getElementById("debugInfo");
        debugElement.textContent = JSON.stringify(info, null, 2);
      }

      // Initialize
      window.addEventListener("DOMContentLoaded", () => {
        checkConnection();
        addMessage(
          "Hello! I'm ready to help you find the perfect outfit. Try one of the test buttons above or type your own message!"
        );
      });
    </script>
  </body>
</html>
